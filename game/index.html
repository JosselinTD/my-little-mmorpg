<!DOCTYPE html>
<html>
<head>
	<title></title>
	<style>
		body {
			overflow: hidden;
		}
	</style>
</head>
<body>
	<div id="stage"></div>
	<script type="text/javascript" src="../node_modules/craftyjs/dist/crafty.js"></script>
	<script type="text/javascript">
		var currentLength = 0;
		var canvasLength = 800;

		Crafty.init(canvasLength, 600, 'stage')
			.background('grey');

		generatePanel(canvasLength);

		var player = Crafty.e("2D, Canvas, Color, Twoway, Gravity")
		    .attr({x:10, y:520, w:30, h:40})
		    .color("red")
		    .twoway(200)
		    .gravityConst(750)
		    .gravity("Floor")
		    .bind('Move', follow)
		    .bind('Move', construct);

		function generatePanel(size) {
			var origin = currentLength;
			var offset = 75;
			var limit = origin + canvasLength - offset;

			// Required extrimities
			Crafty.e("2D, Canvas, Color, Floor")
				.attr({x:origin, y:550, w:offset, h:50})
				.color("black");
			Crafty.e("2D, Canvas, Color, Floor")
				.attr({x:limit, y:550, w:offset, h:50})
				.color("green");

			// Random floor
			generateSection(origin + offset, limit, 550, true);

			currentLength += size;

			// Random etages
			generateSection(origin, currentLength, 450);

		}

		function generateSection(origin, limit, y, holeLimit) {
			var triggerSize = 100; // Minimal size for a platform or a hole
			var maxSection = Math.floor((limit - origin) / triggerSize); // Maximum number of platform and hole
			var nbSection = Math.floor(Math.random() * maxSection) + 1;
			var availableFloor = nbSection;
			var nbHole = 0;
			if (holeLimit) {
				availableFloor = Math.ceil(nbSection / 2);
				nbHole = nbSection - availableFloor;
			}
			var availableFloorSize = limit - origin;
			if (holeLimit) {
				availableFloorSize -= nbHole * triggerSize;
			}
			var i;
			for (i = 0; i < nbSection; i++) {
				var sectionSize = triggerSize;
				if (i % 2 !== 0 && holeLimit) {
					// Si c'est pas une plateforme et que les trous sont fixes
				} else {
					// Si c'est une section ou que les trous sont variables
					availableFloor--;
					if (availableFloor === 0) {
						sectionSize = availableFloorSize;
					} else {
						var floorSizeMax = availableFloorSize - availableFloor * triggerSize;
						sectionSize = Math.floor(Math.random() * (floorSizeMax - triggerSize)) + triggerSize;
						availableFloorSize -= sectionSize;
					}
					// Make a floor
					if (i % 2 === 0) {
						Crafty.e("2D, Canvas, Color, Floor")
							.attr({x:origin, y:y, w:sectionSize, h:50})
							.color("blue");
					}
				}

				origin += sectionSize;
			}
		}

		function follow() {
			var offset = 150;
			var rect = Crafty.viewport.rect();

	    	if (this.x < offset || this.x + this.w > currentLength - offset) {
	    		return;
	    	}

	    	if (this.x < rect._x + offset) {
	    		Crafty.viewport.scroll('x', - (this.x - offset));
	    	}

	    	if (this.x + this.w > rect._x + rect._w - offset) {
	    		var newVal = - (this.x + this.w + offset - rect._w)
	    		Crafty.viewport.scroll('x', newVal);
	    	}
		}

		function construct() {
			var offset = 200;
			if (this.x + this.w < currentLength - offset) {
	    		return;
	    	}

	    	generatePanel(canvasLength);
		}
	</script>
</body>
</html>
